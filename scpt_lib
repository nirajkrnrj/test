ZnVuY3Rpb24gZG9tYWluQ29udmVydGVyKFN0cmluZyB3ZWJBdmxiQ2QpOlN0cmluZw0KICAgew0KICAgU3RyaW5nIGRvbWFpbiA7DQogICAvL2NvbnZlcnRpbmcgd2ViIGF2YWlsaWJpbHR5IGNvZGUgZm9yIGNvbXBhcmlzb24gDQogICANCiAgIA0KICAgaXMgKHdlYkF2bGJDZCkgDQogICAgICB7DQogICAgICAiMSIgOiBkb21haW4gPSAifEhNfERCfERDfFNBIjsNCiAgICAgICIyIiA6IGRvbWFpbiA9ICJ8SE0iOw0KICAgICAgIjMiIDogZG9tYWluID0gInxEQiI7DQogICAgICAiNCIgOiBkb21haW4gPSAifERDIjsNCiAgICAgICI1IiA6IGRvbWFpbiA9ICJ8SE18REIiOw0KICAgICAgIjYiIDogZG9tYWluID0gInxITXxEQyI7DQogICAgICAiNyIgOiBkb21haW4gPSAifERCfERDIjsNCiAgICAgIH0gDQogICANCiAgIHJldHVybiBkb21haW47DQogICB9DQovLyAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09DQoNCg0KZnVuY3Rpb24gd2ViUmVmZXJlbmNlQ2hlY2soU3RyaW5nIENtcHNBcHBsQ2QsIFN0cmluZyB3ZWJBdmxiQ2QsIEJvb2wgZGJXZWJBdmxiQ29kZSwgQm9vbCBjbVdlYkF2bGJDZCk6U3RyaW5nDQogICB7DQogICBJbnQgaSA9IDA7DQogICBTdHJpbmcgd2ViUmVmZXJlbmNlOw0KICAgDQogICAvL3ZhciBkb21haW4gPSBuZXcgQXJyYXkoKTsNCiAgIA0KICAgLy9jb252ZXJ0aW5nIHdlYiBhdmFpbGliaWx0eSBjb2RlIGZvciBjb21wYXJpc29uIA0KICAgaWYgKENtcHNBcHBsQ2QgIT0gIkNNIikNCiAgICAgIHsNCiAgICAgIC8vIEFkZGVkIGNvZGUgZm9yIEJQIGRvbWFpbi4gZGVmZWN0ICMzMzk3IDAyLjI5LjIwMTINCiAgICAgIC8vLS0tLVN0YXJ0DQogICAgICBpZigoQ21wc0FwcGxDZCAhPSAiSE0iIGFuZCBDbXBzQXBwbENkICE9ICJEQiIgYW5kIENtcHNBcHBsQ2QgIT0gIkRDIikgYW5kIHdlYkF2bGJDZCAhPSAiOCIpDQogICAgICAgICB7DQogICAgICAgICB3ZWJSZWZlcmVuY2UgPSAidHJ1ZSI7DQogICAgICAgICB9DQogICAgICAvLy0tLS1FTkQNCiAgICAgIA0KICAgICAgU3RyaW5nIGRvbWFpbiA9IGRvbWFpbkNvbnZlcnRlcih3ZWJBdmxiQ2QpOw0KICAgICAgLy9jb21wYXJpbmcNCiAgICAgIGZvciAoaSA9IDA7IGkgPCBkb21haW4uZmluZCgifCIpOyBpKyspDQogICAgICAgICB7DQogICAgICAgICBpZiAoZG9tYWluLlBhcnRbaSwifCJdID09IENtcHNBcHBsQ2QpDQogICAgICAgICAgICB7DQogICAgICAgICAgICBpZiAoQ21wc0FwcGxDZCA9PSAiREIiKQ0KICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgaWYgKGRiV2ViQXZsYkNvZGUgPT0gdHJ1ZSkNCiAgICAgICAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICAgIHdlYlJlZmVyZW5jZSA9ICJ0cnVlIjsNCiAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZQ0KICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgd2ViUmVmZXJlbmNlID0gInRydWUiOw0KICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgfSAgIA0KICAgICAgfQ0KICAgZWxzZS8vZWxzZSBpZiAoQ21wc0FwcGxDZCA9PSAiQ00iKSAtLSB0b29rIHRoaXMgb3V0IC0tIGl0IGlzIHVubmVjZXNzYXJ5DQogICAgICB7DQogICAgICBpZiAod2ViQXZsYkNkICE9ICI4IikNCiAgICAgICAgIHsNCiAgICAgICAgIGlmIChjbVdlYkF2bGJDZCA9PSBmYWxzZSApDQogICAgICAgICAgICB7DQogICAgICAgICAgICB3ZWJSZWZlcmVuY2UgPSAiZmFsc2UiOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgLy99ZWxzZSBpZiAoIChDbXBzQXBwbENkICE9ICJITSIgfHwgQ21wc0FwcGxDZCAhPSAiREIiIHx8IENtcHNBcHBsQ2QgIT0gIkRDIikgJiYgd2ViQXZsYkNkICE9ICI4IikNCiAgICAgICAgIC8vIHRvb2sgb3V0IHRoZSBhYm92ZSBjaGVja3MgZm9yIHRoZSBkb21haW4sIHNpbmNlIHdlIGtub3cgdGhleSBtdXN0IGJlIHRydWU7IHdlIGFyZSBpbg0KICAgICAgICAgLy8gY29kZSB0aGF0IG9ubHkgZXhlY3V0ZXMgd2hlbiBDbXBzQXBwbENkID09ICJDTSINCiAgICAgICAgIGVsc2UgDQogICAgICAgICAgICB7DQogICAgICAgICAgICB3ZWJSZWZlcmVuY2UgPSAidHJ1ZSI7DQogICAgICAgICAgICB9DQogICAgICAgICB9DQogICAgICANCiAgICAgIH0NCiAgIHJldHVybiB3ZWJSZWZlcmVuY2U7DQogICB9DQoNCiAvLy8vLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIA0KZnVuY3Rpb24gbm9uVGd0RW1haWxCcmFuZGVkU2VsZWN0aW9uVmFyaWFibGVWYWx1ZShTdHJpbmcgYnJhbmRlZFNlbGVjdGlvblZhcmlhYmxlTmFtZSwgU3RyaW5nIGNvZGVkVmFyaWFibGVJZCxTdHJpbmcgU2xjdF9EZm5fSWQsU3RyaW5nIEZybWxfUGFzc19DZCk6Qm9vbA0KICAgew0KICAgICAgICAgaWYoY29kZWRWYXJpYWJsZUlkID09ICIiKQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgaWYoU2xjdF9EZm5fSWQgPT0gIiIpDQogICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICBjb2RlZFZhcmlhYmxlSWQgPSBTbGN0X0Rmbl9JZDsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGJyYW5kZWRTZWxlY3Rpb25WYXJpYWJsZU5hbWUucmVwbGFjZSggIl8iLCAiLSIpOw0KICAgICAgICAgICAgaWYoY29kZWRWYXJpYWJsZUlkLmVxdWFsQ2FzZUluc2Vuc2l0aXZlKGJyYW5kZWRTZWxlY3Rpb25WYXJpYWJsZU5hbWUpKQ0KICAgICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgICAgaWYoRnJtbF9QYXNzX0NkLnRvQm9vbCgpKQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgfQ0KICAgfQ0KICAgDQogICAgICAgIA0KLy9TdHJpbmcgLSBSZXR1cm4gQ3VycmVudCBUaW1lc3RhbXANCmZ1bmN0aW9uIGdldFRpbWVzdGFtcCgpOlN0cmluZw0KICAgew0KICAgRGF0ZVRpbWUgZHQgPSBEYXRlVGltZS5Ob3c7DQogICAvLyBudW1iZXIgb2YgZGF5cyBzaW5jZSAxMi8zMC8xODk5DQogICBJbnQgbm93ID0gZHQuRGF5czsNCiAgIFN0cmluZyBtcyA9IGR0Lk1pbGxpc2Vjb25kLnRvU3RyaW5nKDMsdHJ1ZSk7DQogICANCiAgIC8vIG5vdyBtaW51cyBudW1iZXIgb2YgZGF5cyBiZXR3ZWVuIDEyLzMwLzE4OTkgYW5kIDEvMS8xOTcwDQogICBub3cgLT0gKERhdGVUaW1lLmZyb21EYXRlKDEsMSwxOTcwKS5EYXlzKTsNCiAgIA0KICAgLy9udW1iZXIgb2YgZGF5cyBiZXR3ZWVuIDEvMS8xOTcwIGFuZCBub3cgKiA2MCAqIDYwICogMjQgKHNlY29uZHMgKiBtaW51dGVzICogaG91cnMpDQogICBJbnQgZXBvY2ggPSBub3cgKiA2MCAqIDYwICoyNDsNCiAgIGVwb2NoICs9IGR0LlNlY29uZE9mRGF5Ow0KICAgDQogICByZXR1cm4gZXBvY2gudG9TdHJpbmcoKSttczsNCiAgIH0NCg0KDQovL0Z1bmN0aW9uIHRvIGFkZCBsZWFkaW5nIHplcm9zDQpmdW5jdGlvbiBhZGRMZWFkaW5nWmVyb3MoU3RyaW5nIGlucHV0U3RyaW5nLCBJbnQgZmluYWxMZW5ndGgpOlN0cmluZw0KICAgew0KICAgaWYoaW5wdXRTdHJpbmcuTGVuZ3RoID49IGZpbmFsTGVuZ3RoKQ0KICAgICAgaW5wdXRTdHJpbmcgPSBpbnB1dFN0cmluZy5yaWdodChmaW5hbExlbmd0aCk7DQogICBlbHNlDQogICAgICBpbnB1dFN0cmluZy5yaWdodEp1c3RpZnkoZmluYWxMZW5ndGgsIjAiLHRydWUpOw0KICAgcmV0dXJuIGlucHV0U3RyaW5nOw0KICAgfQ0KDQoNCi8vRnVuY3Rpb24gdG8gZm9yY2UgYSBzcGVjaWZpYyBmaWVsZCB3aWR0aA0KZnVuY3Rpb24gc2V0U3BlY2lmaWNXaWR0aChTdHJpbmcgaW5wdXRTdHJpbmcsIEludCBmaW5hbExlbmd0aCk6U3RyaW5nDQogICB7DQogICBpZihpbnB1dFN0cmluZy5MZW5ndGggPj0gZmluYWxMZW5ndGgpDQogICAgICBpbnB1dFN0cmluZyA9IGlucHV0U3RyaW5nLmxlZnQoZmluYWxMZW5ndGgpOw0KICAgZWxzZQ0KICAgICAgaW5wdXRTdHJpbmcubGVmdEp1c3RpZnkoZmluYWxMZW5ndGgsIiAiLHRydWUpOw0KICAgcmV0dXJuIGlucHV0U3RyaW5nOw0KICAgfQ0KDQo
